<!DOCTYPE html>
<meta charset="utf-8">

<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

const width = 960, height = 500;

const svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("style", "border: 1px solid black");

d3.json("data.json", function(json) {

    // Pre-process
    const linksWithSites = json.links.map(function (link) {
        const l1 = json.nodes.find(function (node) {
            return node.id === link.node01;
        });
        const l2 = json.nodes.find(function (node) {
            return node.id === link.node02;
        });
        return {
            node01: l1,
            node02: l2,
            amount: link.amount,
        };
    });

    /* Define the data for the circles */
    const siteElements = svg.selectAll("g sites")
        .data(json.nodes);

    const linkElements = svg.selectAll("g links")
        .data(linksWithSites);

    const defaultAmounts = json.nodes.reduce(function (acc, node) {
        return Object.assign(acc, {
            [node.id]: 0,
        });
    }, {});

    const defaultLinkCounts = json.nodes.reduce(function (acc, node) {
        return Object.assign(acc, {
            [node.id]: 0,
        });
    }, {});

    const amounts = json.links.reduce(function (acc, link) {
        const node01Amount = acc[link.node01];
        const node02Amount = acc[link.node02];
        return Object.assign(acc, {
            [link.node01]: node01Amount + link.amount,
            [link.node02]: node02Amount + link.amount,
        });
    }, defaultAmounts);

    const linkCounts = json.links.reduce(function (acc, link) {
        const node01LinkCount = acc[link.node01];
        const node02LinkCount = acc[link.node02];
        return Object.assign(acc, {
            [link.node01]: node01LinkCount + 1,
            [link.node02]: node02LinkCount + 1,
        });
    }, defaultLinkCounts);

    const siteElemsEnter = siteElements.enter();

    /*Create the circle for each block */
    const circle = siteElemsEnter.append("circle")
        .attr("cx", function (d) { return d.x; })
        .attr("cy", function (d) { return d.y; })
        .attr("r", function (d) { return amounts[d.id] / 100; })
        .attr("stroke", "black")
        .attr("fill", "black")
        .on("mouseover", function (d) {
            siteElements.attr("opacity", function (s) {
                return (s.id === d.id) ? 1 : 0.3;
            });
            linkElements.attr("opacity", function (l) {
                return (l.node01.id === d.id || l.node02.id === d.id) ? 1 : 0.3;
            });
        })
        .on("mouseout", function (d) {
            siteElements.attr("opacity", 1);
            linkElements.attr("opacity", 1);
        })
        .append("svg:title")
            .text(function(d) {
                return `id: ${d.id}, amount: ${amounts[d.id]}, links: ${linkCounts[d.id]}`;
            });

    const linkElemsEnter = linkElements.enter();
    linkElemsEnter.append("line")
        .attr("x1", function (d) { return d.node01.x; })
        .attr("y1", function (d) { return d.node01.y; })
        .attr("x2", function (d) { return d.node02.x; })
        .attr("y2", function (d) { return d.node02.y; })
        .attr("stroke-width", function (d) { return d.amount / 100; })
        .attr("stroke", "black");
})
</script>

</body>
