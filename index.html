<!DOCTYPE html>
<meta charset="utf-8">

<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

const width = 960, height = 500;

const svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("style", "border: 1px solid black");

d3.json("data.json", function(json) {
    /* Define the data for the circles */
    const elem = svg.selectAll("g sites")
        .data(json.nodes);

    const defaultAmounts = json.nodes.reduce(function (acc, node) {
        return Object.assign(acc, {
            [node.id]: 0,
        });
    }, {});

    const amounts = json.links.reduce(function (acc, link) {
        const node01Amount = acc[link.node01];
        const node02Amount = acc[link.node02];
        return Object.assign(acc, {
            [link.node01]: node01Amount + link.amount,
            [link.node02]: node02Amount + link.amount,
        });
    }, defaultAmounts);

    /*Create and place the "blocks" containing the circle and the text */
    const elemEnter = elem.enter();
        // .append("g")
        // .attr("transform", function (d) {
        //     return `translate(${d.x}, ${d.y})`;
        // });

    /*Create the circle for each block */
    const circle = elemEnter.append("circle")
        .attr("cx", function (d) { return d.x; })
        .attr("cy", function (d) { return d.y; })
        .attr("r", function (d) { return amounts[d.id] / 100; })
        .attr("stroke", "black")
        .attr("fill", "black");

    /* Create the text for each block */
    elemEnter.append("text")
        .attr("dx", function (d) { return d.x + 6; })
        .attr("dy", function (d) { return d.y + 4; })
        .text(function (d) { return d.id; });

    const linksWithSites = json.links.map(function (link) {
        const l1 = json.nodes.find(function (node) {
            return node.id === link.node01;
        });
        const l2 = json.nodes.find(function (node) {
            return node.id === link.node02;
        });
        return {
            node01: l1,
            node02: l2,
            amount: link.amount,
        };
    });

    const linkElement = svg.selectAll("g links")
        .data(linksWithSites);
    const linkElemEnter = linkElement.enter();
    linkElemEnter.append("line")
        .attr("x1", function (d) { return d.node01.x; })
        .attr("y1", function (d) { return d.node01.y; })
        .attr("x2", function (d) { return d.node02.x; })
        .attr("y2", function (d) { return d.node02.y; })
        .attr("stroke-width", function (d) { return d.amount / 100; })
        .attr("stroke", "black");
})
</script>

</body>
